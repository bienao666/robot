<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bienao.robot.mapper.jingdong.JdCkMapper">
    <select id="queryCk" parameterType="jdCkEntity" resultType="jdCkEntity">
        select * from jdck where 1=1
        <if test="id != null">
            AND id = #{id}
        </if>
        <if test="ck != null and ck != ''">
            AND ck = #{ck}
        </if>
        <if test="ptPin != null and ptPin != ''">
            AND pt_pin = #{ptPin}
        </if>
        <if test="level != null">
            AND level = #{level}
        </if>
    </select>

    <select id="queryCks" parameterType="jdCkEntity" resultType="jdCkEntity">
        select * from jdck where 1=1
        <if test="id != null">
            AND id = #{id}
        </if>
        <if test="ck != null and ck != ''">
            AND ck = #{ck}
        </if>
        <if test="ptPin != null and ptPin != ''">
            AND pt_pin = #{ptPin}
        </if>
        <if test="level != null">
            AND level = #{level}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="remark !=null and remark !=''">
            and remark like ('%'||#{remark}||'%')
        </if>
        order by level
    </select>

    <select id="queryCksByLevels" resultType="jdCkEntity">
        select * from jdck where 1=1 and level in (${levels}) and status = 0
    </select>

    <insert id="addCk" parameterType="jdCkEntity">
        insert into jdck(ck,pt_pin,remark,level,expiry_time) values (#{ck},#{ptPin},#{remark},#{level},#{expiryTime});
    </insert>

    <update id="updateCk" parameterType="jdCkEntity">
        update jdck
        <set>
            <if test="ck != null and ck != ''">
                ck = #{ck},
            </if>
            <if test="ptPin != null and ptPin != ''">
                pt_pin = #{ptPin},
            </if>
            <if test="remark != null and remark != ''">
                remark = #{remark},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="level != null">
                level = #{level},
            </if>
            <if test="jd != null">
                jd = #{jd},
            </if>
                expiry_time = #{expiryTime},
            <if test="updatedTime != null">
                updated_time = #{updatedTime},
            </if>
        </set>
        where id=#{id};
    </update>

    <delete id="deleteCks" parameterType="jdCkEntity">
        delete from jdck where 1=1 and id in
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>


    <resultMap id="ckFruitMap" type="jdCkEntity">
        <id property="id" column="id"></id>
        <result property="ck" column="ck"></result>
        <result property="remark" column="remark"></result>
        <result property="status" column="status"></result>
        <result property="level" column="level"></result>
        <result property="jd" column="jd"></result>
        <association  property="jdFruitEntity" javaType="jdFruitEntity" column="id" select="queryJdFruit" ></association >
        <association  property="jdPetEntity" javaType="jdPetEntity" column="id" select="queryJdPet" ></association >
        <association  property="jdPlantEntity" javaType="jdPlantEntity" column="id" select="queryJdPlant" ></association >
    </resultMap>

    <select id="queryCksAndActivity" resultMap="ckFruitMap">
        select * from jdck where status = 0 and level != 4 order by level,created_time desc
    </select>

    <select id="queryJdFruit" resultType="jdFruitEntity">
        select * from jdFruit where ckid=#{id}
    </select>

    <select id="queryJdPet" resultType="jdPetEntity">
        select * from jdPet where ckid=#{id}
    </select>

    <select id="queryJdPlant" resultType="jdPlantEntity">
        select * from jdPlant where ckid=#{id}
    </select>

    <select id="sumJdCount" resultType="integer">
        select sum(jd) from jdck where jd IS NOT NULL
    </select>

    <update id="resetJd">
        update jdck set jd = 0
    </update>

    <select id="queryCkCount" resultType="java.lang.Integer">
        select count(*) from jdck where 1 = 1 and level in (0,1,2,3) and status = 0
    </select>

    <select id="queryHasHelpFruitCk" resultType="jdCkEntity">
        select * from jdck where 1 = 1 and id in (select ckid from jdFruit where help_status =1)
    </select>

    <select id="queryHasHelpPetCk" resultType="jdCkEntity">
        select * from jdck where 1 = 1 and id in (select ckid from jdPet where help_status =1)
    </select>

    <select id="queryHasHelpPlantCk" resultType="jdCkEntity">
        select * from jdck where 1 = 1 and id in (select ckid from jdPlant where help_status =1)
    </select>

</mapper>
